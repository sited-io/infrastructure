---
# @meta description: >
# Requires [Vault](../../vault/) to be run in order to use consul secret engine
#
# - Generate initial gossip encryption key and configure in agent config
# @end

- ansible.builtin.import_tasks: ../../common-tasks/vault_login/vault_login.yaml

- name: Ensure consul config directory
  ansible.builtin.file:
    path: "{{ consul.config_dir }}"
    state: directory
    owner: consul
    group: consul
    mode: "774"

- run_once: true
  delegate_to: localhost
  become: false
  environment:
    VAULT_ADDR: "{{ vault_addr }}"
    VAULT_TOKEN: "{{ vault_token }}"
  block:
    - name: Ensure working directory
      ansible.builtin.file:
        path: /tmp/consul/gossip
        state: directory

    - name: Ensure vault kv2 is enabled
      ansible.builtin.command: |
        vault secrets enable -version 2 -path kv2 kv
      register: enable_kv2_out
      failed_when: enable_kv2_out.rc != 0 and 'path is already in use' not in enable_kv2_out.stderr

    - name: Generate gossip encryption key
      ansible.builtin.command: consul keygen
      register: gossip_key_out

    - ansible.builtin.set_fact:
        gossip_key: "{{ gossip_key_out.stdout }}"

    - name: Save gossip key to vault
      ansible.builtin.command: |
        vault kv put -mount=kv2 /consul/config/encryption \
          key={{ gossip_key }}

- ansible.builtin.file:
    path: "{{ consul.config_dir }}/server.gossip.hcl"
    state: absent

- name: Copy server gossip configuration
  ansible.builtin.template:
    src: gossip.hcl.j2
    dest: "{{ consul.config_dir }}/gossip.hcl"
    owner: consul
    group: consul
    mode: "440"

- name: Restart consul service
  ansible.builtin.service:
    name: consul
    state: restarted
  when: inventory_hostname in groups.consul_servers

- name: Wait
  ansible.builtin.pause:
    seconds: 20

- name: Restart consul service
  throttle: 2
  ansible.builtin.service:
    name: consul
    state: restarted
  when: inventory_hostname in groups.consul_clients
